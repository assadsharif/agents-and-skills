# Data Model: Stock Signal API

**Feature**: Stock Signal API
**Branch**: `001-stock-signal-api`
**Date**: 2026-02-13

## Overview

This document defines the data structures for the Stock Signal API. All models are implemented using Pydantic v2 for validation and serialization.

---

## Domain Entities

### 1. Stock

Represents a publicly traded equity security.

**Source**: External data providers (Yahoo Finance via yfinance)

**Attributes**:
```python
class Stock:
    ticker: str              # Stock symbol (e.g., "AAPL")
    company_name: str        # Company name (e.g., "Apple Inc.")
    exchange: str            # Exchange code (e.g., "NASDAQ", "NYSE")
    current_price: Decimal   # Most recent closing price
```

**Validation Rules**:
- `ticker`: 1-5 uppercase alphanumeric characters, required
- `company_name`: Max 200 characters, required
- `exchange`: Enum["NASDAQ", "NYSE"], required
- `current_price`: Positive decimal, 2 decimal places, required

**Constraints**:
- Ticker must be valid US stock (NYSE, NASDAQ only for MVP)
- Price must reflect most recent available close price

**Relationships**:
- Has many `PriceData` records (historical prices)
- Generates `Signal` outputs

---

### 2. PriceData

Historical OHLCV (Open, High, Low, Close, Volume) data for technical analysis.

**Source**: Fetched from yfinance, cached in memory

**Attributes**:
```python
class PriceData:
    ticker: str              # Associated stock symbol
    date: date               # Trading date (YYYY-MM-DD)
    open: Decimal            # Opening price
    high: Decimal            # Highest price during day
    low: Decimal             # Lowest price during day
    close: Decimal           # Closing price
    volume: int              # Number of shares traded
```

**Validation Rules**:
- `date`: Valid date, not future date, required
- `open`, `high`, `low`, `close`: Positive decimals, 2 decimal places, required
- `high` >= `low`, required
- `high` >= `open`, `close`, `low`, required
- `low` <= `open`, `close`, `high`, required
- `volume`: Non-negative integer, required

**Constraints**:
- Minimum 200 days required for reliable long-term indicators (200-day SMA)
- Daily granularity only (no intraday) for MVP
- Data freshness: 15-minute delay acceptable

**Relationships**:
- Belongs to one `Stock`
- Used to calculate `TechnicalIndicator` values

**State Transitions**: Immutable once fetched (historical data)

---

### 3. TechnicalIndicator

Calculated metrics derived from price data for technical analysis.

**Source**: Computed from PriceData using pandas-ta library

**Attributes**:
```python
class TechnicalIndicator:
    ticker: str                    # Associated stock symbol
    calculated_at: datetime        # When indicators were calculated (UTC)
    rsi: Optional[Decimal]         # Relative Strength Index (0-100)
    macd_line: Optional[Decimal]   # MACD line value
    macd_signal: Optional[Decimal] # MACD signal line value
    macd_histogram: Optional[Decimal] # MACD histogram
    sma_20: Optional[Decimal]      # 20-day Simple Moving Average
    sma_50: Optional[Decimal]      # 50-day Simple Moving Average
    sma_200: Optional[Decimal]     # 200-day Simple Moving Average
    ema_12: Optional[Decimal]      # 12-day Exponential Moving Average
    ema_26: Optional[Decimal]      # 26-day Exponential Moving Average
```

**Validation Rules**:
- `ticker`: Required, 1-5 uppercase alphanumeric
- `calculated_at`: Required, UTC timezone
- `rsi`: If present, must be 0-100 range
- All decimal values: 2-4 decimal places
- At least one indicator must be non-null

**Calculation Parameters** (Industry Standards):
- RSI: 14-period (Wilder's formula)
- MACD: 12-period EMA, 26-period EMA, 9-period signal line
- SMA: 20, 50, 200 trading days
- EMA: 12, 26 trading days

**Derivation Logic**:
```python
# Requires minimum data:
# - RSI: 14 days
# - MACD: 26 days (for 26-period EMA)
# - SMA 20: 20 days
# - SMA 50: 50 days
# - SMA 200: 200 days
# - EMA 12: 12 days
# - EMA 26: 26 days
```

**Constraints**:
- All indicators optional (support partial results for new stocks)
- Null indicators must be noted in signal reasoning
- Stale after 15 minutes (cache TTL)

**Relationships**:
- Belongs to one `Stock`
- Derived from `PriceData`
- Used by `SignalGenerator` to produce `Signal`

---

### 4. Signal

Trading recommendation with confidence level and reasoning.

**Source**: Generated by SignalGenerator from TechnicalIndicator values

**Attributes**:
```python
class Signal:
    ticker: str              # Stock symbol signal applies to
    action: SignalAction     # Enum: BUY, SELL, HOLD
    confidence: int          # Confidence level (0-100%)
    reasoning: str           # Human-readable explanation
    generated_at: datetime   # When signal was generated (UTC)
    data_freshness: datetime # Timestamp of underlying price data (UTC)
    current_price: Decimal   # Current stock price
    indicators: TechnicalIndicator  # Underlying indicator values
```

**Validation Rules**:
- `ticker`: Required, 1-5 uppercase alphanumeric
- `action`: Required, must be one of ["BUY", "SELL", "HOLD"]
- `confidence`: Required, integer 0-100
- `reasoning`: Required, min 20 characters, max 500 characters
- `generated_at`: Required, UTC timezone
- `data_freshness`: Required, UTC timezone, must be <= generated_at
- `current_price`: Required, positive decimal, 2 decimal places
- `indicators`: Required, embedded object

**Signal Generation Logic** (from research.md):
```
Score = 0 (neutral)

BUY signals (+points):
  RSI < 30: +2 (strong oversold)
  RSI < 40: +1 (mild oversold)
  MACD bullish crossover: +2
  Price > 50-day SMA: +1
  Price > 200-day SMA: +1

SELL signals (-points):
  RSI > 70: -2 (strong overbought)
  RSI > 60: -1 (mild overbought)
  MACD bearish crossover: -2
  Price < 50-day SMA: -1
  Price < 200-day SMA: -1

Final Signal:
  Score >= +2: BUY
  Score <= -2: SELL
  -1 to +1: HOLD

Confidence = min(abs(score) * 20, 100)
```

**Reasoning Format**:
```
Template: "{Signal} signal: {primary_reasons}, {supporting_reasons}"

Examples:
- "Strong BUY signal: RSI at 28.5 (oversold), MACD bullish crossover detected, price above 50-day SMA ($175.20 > $172.50)"
- "SELL signal: RSI at 72.3 (overbought), price below 200-day SMA ($150.00 < $155.50)"
- "HOLD signal: Mixed indicators - RSI neutral at 55, MACD shows no clear trend"
```

**Constraints**:
- Point-in-time recommendation (not persistent)
- Becomes stale as market moves (15-minute cache TTL)
- Must reference at least 2 indicators in reasoning (unless insufficient data)
- Confidence correlates with indicator agreement

**Relationships**:
- Belongs to one `Stock`
- Contains one `TechnicalIndicator` (embedded)
- Generated from `PriceData` → `TechnicalIndicator` pipeline

**State Transitions**:
- Immutable once generated
- Becomes stale after cache TTL (15 minutes)
- New request generates new signal

---

## Enumerations

### SignalAction
```python
class SignalAction(str, Enum):
    BUY = "BUY"
    SELL = "SELL"
    HOLD = "HOLD"
```

### Exchange
```python
class Exchange(str, Enum):
    NASDAQ = "NASDAQ"
    NYSE = "NYSE"
```

---

## Data Flow

```
External API (yfinance)
    ↓
[Fetch] → PriceData (200 days historical)
    ↓
[Calculate] → TechnicalIndicator (RSI, MACD, SMA, EMA)
    ↓
[Generate] → Signal (action, confidence, reasoning)
    ↓
[Serialize] → JSON Response (to API client)
```

---

## Caching Strategy

### Cache Key Design
```python
# Format: "price_data:{ticker}:{date}"
# Example: "price_data:AAPL:2026-02-13"

# Format: "signal:{ticker}"
# Example: "signal:AAPL"
```

### TTL Configuration
- **PriceData**: 15 minutes (matches data freshness assumption)
- **Signal**: 15 minutes (aligned with PriceData staleness)
- **TechnicalIndicator**: Not cached separately (computed from PriceData)

### Cache Size
- **Capacity**: 500 tickers
- **Eviction**: LRU (Least Recently Used)
- **Hit rate target**: 80% (per SC-007)

---

## Error Scenarios & Data States

### Insufficient Historical Data
```python
# New IPO with only 50 days of data
TechnicalIndicator(
    ticker="NEWSTOCK",
    rsi=45.2,           # ✅ Calculated (needs 14 days)
    macd_line=None,     # ✅ Calculated (needs 26 days)
    sma_20=102.5,       # ✅ Calculated (needs 20 days)
    sma_50=None,        # ❌ Insufficient data (needs 50 days)
    sma_200=None,       # ❌ Insufficient data (needs 200 days)
    ema_12=103.2,       # ✅ Calculated (needs 12 days)
    ema_26=None         # ✅ Calculated (needs 26 days)
)

# Signal reasoning notes missing indicators:
"HOLD signal: Limited data (only 50 days available). RSI at 45.2 (neutral), price above 20-day SMA. Unable to assess long-term trend (200-day SMA unavailable)."
```

### Data Source Unavailable
```python
# Returns error response (not Signal object)
{
    "error": "data_source_unavailable",
    "message": "Unable to fetch price data for AAPL. Data source (Yahoo Finance) is currently unavailable.",
    "retry_after": 300,  # seconds
    "ticker": "AAPL"
}
```

### Invalid Ticker
```python
# Returns error response
{
    "error": "invalid_ticker",
    "message": "Invalid ticker symbol 'XYZ123'. Ticker must be 1-5 uppercase alphanumeric characters for US stocks (NYSE, NASDAQ).",
    "ticker": "XYZ123"
}
```

---

## Database Schema (Future - Not MVP)

MVP uses in-memory cache only. Future persistent storage would use:

```sql
-- Not implemented in MVP (out of scope)
-- Included for future reference

CREATE TABLE stocks (
    ticker VARCHAR(5) PRIMARY KEY,
    company_name VARCHAR(200) NOT NULL,
    exchange VARCHAR(10) NOT NULL,
    updated_at TIMESTAMP NOT NULL
);

CREATE TABLE price_data (
    id SERIAL PRIMARY KEY,
    ticker VARCHAR(5) REFERENCES stocks(ticker),
    date DATE NOT NULL,
    open DECIMAL(10, 2) NOT NULL,
    high DECIMAL(10, 2) NOT NULL,
    low DECIMAL(10, 2) NOT NULL,
    close DECIMAL(10, 2) NOT NULL,
    volume BIGINT NOT NULL,
    UNIQUE(ticker, date)
);

CREATE INDEX idx_price_data_ticker_date ON price_data(ticker, date DESC);
```

---

## Validation Matrix

| Entity | Required Fields | Optional Fields | Cross-Field Validations |
|--------|----------------|-----------------|------------------------|
| Stock | ticker, company_name, exchange, current_price | - | ticker format (1-5 chars), exchange enum |
| PriceData | ticker, date, open, high, low, close, volume | - | high >= low, high >= open/close, low <= open/close |
| TechnicalIndicator | ticker, calculated_at | rsi, macd_*, sma_*, ema_* | At least one indicator non-null, RSI 0-100 |
| Signal | ticker, action, confidence, reasoning, generated_at, data_freshness, current_price, indicators | - | confidence 0-100, action enum, reasoning 20-500 chars, data_freshness <= generated_at |

---

## Implementation Notes

1. **Pydantic Models**: All entities implemented as Pydantic v2 BaseModel for validation
2. **Decimal vs Float**: Use `Decimal` for price/financial data to avoid floating-point errors
3. **Timezone**: All datetime fields stored in UTC, formatted as ISO 8601 in JSON
4. **Immutability**: PriceData and Signal are immutable once created (no updates)
5. **Graceful Degradation**: TechnicalIndicator supports partial results (null fields)

---

**Data Model Complete**: Ready for contract generation (OpenAPI schema).
