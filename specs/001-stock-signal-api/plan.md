# Implementation Plan: Stock Signal API

**Branch**: `001-stock-signal-api` | **Date**: 2026-02-13 | **Spec**: [spec.md](./spec.md)
**Input**: Feature specification from `/specs/001-stock-signal-api/spec.md`

## Summary

Build a REST API that provides buy/sell/hold trading signals for US stocks based on technical analysis. The API calculates four technical indicators (RSI, MACD, SMA, EMA) from historical price data fetched from Yahoo Finance, then generates signals using a rule-based scoring algorithm. The MVP targets <2s response times for cached data, 99% uptime, and supports 100+ requests/hour.

**Technical Approach**: FastAPI-based async REST API with Python 3.11+, using yfinance for data sourcing, pandas-ta for indicator calculations, and in-memory cachetools for 15-minute TTL caching. Single-service deployment with graceful degradation for partial data scenarios.

## Technical Context

**Language/Version**: Python 3.11+
**Primary Dependencies**: FastAPI 0.100+ (REST API), yfinance 0.2.40+ (data source), pandas-ta 0.3.14+ (indicators), Pydantic 2.0+ (validation), cachetools 5.3+ (caching)
**Storage**: In-memory TTL cache (cachetools) with 15-minute expiry; No persistent database for MVP
**Testing**: pytest 7.4+ with pytest-asyncio for async tests, httpx test client for API integration tests
**Target Platform**: Linux server (containerized deployment ready), ASGI server (uvicorn)
**Project Type**: Single (backend API service only)
**Performance Goals**: <2s response time for cached requests, <1s typical for uncached, 100+ requests/hour capacity, 80% cache hit rate
**Constraints**: <2s p95 latency for cached data, 99% uptime (with external data source graceful degradation), 15-minute data freshness acceptable
**Scale/Scope**: MVP - Single service, REST API with 3 endpoints (signal, indicators, health), US stocks only (NYSE/NASDAQ), Daily data granularity

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

**Status**: ✅ **PASS** (No constitution defined)

The project constitution file (`.specify/memory/constitution.md`) is currently in template form with no defined principles or constraints. Therefore, this feature has no constitution violations to check against.

**Recommendation**: Consider establishing a constitution for future features. Common principles might include:
- Test-Driven Development (TDD) requirements
- API design standards (REST conventions, versioning)
- Security requirements (input validation, secrets management)
- Performance budgets and monitoring requirements
- Code quality gates (coverage thresholds, linting rules)

**Re-evaluation After Phase 1**: No changes. Constitution remains undefined.

## Project Structure

### Documentation (this feature)

```text
specs/001-stock-signal-api/
├── spec.md              # ✅ Feature specification (user stories, requirements)
├── plan.md              # ✅ This file (architecture and design)
├── research.md          # ✅ Technical decisions and research findings
├── data-model.md        # ✅ Entity definitions and validation rules
├── quickstart.md        # ✅ Developer setup and integration guide
├── contracts/
│   └── openapi.yaml     # ✅ REST API contract (OpenAPI 3.0)
├── checklists/
│   └── requirements.md  # ✅ Requirements validation checklist
└── tasks.md             # ⏳ To be generated by /sp.tasks command
```

### Source Code (repository root)

```text
app/
├── main.py                      # FastAPI application entry point, ASGI app
├── config.py                    # Configuration (cache settings, API keys if needed)
├── models/
│   ├── __init__.py
│   ├── stock.py                 # Stock, PriceData Pydantic models
│   ├── indicator.py             # TechnicalIndicator Pydantic model
│   └── signal.py                # Signal, SignalAction Pydantic models
├── services/
│   ├── __init__.py
│   ├── data_fetcher.py          # Yahoo Finance integration (yfinance wrapper)
│   ├── indicator_calculator.py  # Technical indicator calculations (pandas-ta)
│   ├── signal_generator.py      # Signal generation logic (scoring algorithm)
│   └── cache_service.py         # Caching layer (cachetools wrapper)
├── api/
│   ├── __init__.py
│   ├── routes/
│   │   ├── __init__.py
│   │   ├── signals.py           # /signal/{ticker} endpoint
│   │   ├── indicators.py        # /indicators/{ticker} endpoint
│   │   └── health.py            # /health endpoint
│   ├── dependencies.py          # FastAPI dependency injection
│   └── errors.py                # Custom exception handlers
└── utils/
    ├── __init__.py
    └── validators.py            # Ticker validation, data validation helpers

tests/
├── unit/
│   ├── test_models.py           # Pydantic model validation tests
│   ├── test_indicator_calculator.py  # Indicator calculation tests
│   ├── test_signal_generator.py      # Signal generation logic tests
│   └── test_validators.py       # Validation helper tests
├── integration/
│   ├── test_api_signals.py      # /signal endpoint integration tests
│   ├── test_api_indicators.py   # /indicators endpoint tests
│   ├── test_data_fetcher.py     # Yahoo Finance integration tests
│   └── test_cache.py            # Cache behavior tests
└── fixtures/
    └── sample_data.py           # Test fixtures (mock price data)

requirements.txt                 # Python dependencies
pytest.ini                       # Pytest configuration
.env.example                     # Environment variables template (if needed)
README.md                        # Project overview and setup instructions
```

**Structure Decision**: Single backend API project using FastAPI conventions.

**Rationale**:
- **app/**: Main application code following FastAPI best practices
  - **models/**: Pydantic models for validation and serialization (maps to data-model.md entities)
  - **services/**: Business logic layer (data fetching, calculations, signal generation)
  - **api/routes/**: HTTP endpoint handlers (thin layer, delegates to services)
  - **utils/**: Shared utilities and validators
- **tests/**: Organized by test type (unit for isolated logic, integration for end-to-end API flows)
- **No database layer**: MVP uses in-memory cache only, no ORM needed
- **No frontend**: API-only service, frontend integration documented in quickstart.md

**Key Files**:
- `app/main.py`: Creates FastAPI app, registers routers, configures middleware
- `app/services/signal_generator.py`: Implements scoring algorithm from research.md
- `app/api/routes/signals.py`: Implements /signal/{ticker} endpoint per openapi.yaml
- `tests/integration/test_api_signals.py`: Contract tests against openapi.yaml schema

## Complexity Tracking

> **Fill ONLY if Constitution Check has violations that must be justified**

**Status**: N/A - No constitution violations detected.

This section would track justified complexity additions that violate established constitution principles. Since no constitution is currently defined, no violations exist to document.

**Architecture Notes** (for future reference):
- Kept design minimal: No database, no repository pattern, no unnecessary abstractions
- Single service (not microservices) appropriate for MVP scope
- Rule-based algorithm (not ML) keeps system simple and testable
- In-memory cache (not Redis) eliminates external dependencies for MVP

---

## Architectural Decisions

### Significant Decisions Made

The following decisions meet the ADR criteria (long-term impact, multiple alternatives, cross-cutting scope):

1. **Data Source Selection (Yahoo Finance vs Alpha Vantage)**
   - **Impact**: Long-term dependency on external data provider, affects reliability and rate limits
   - **Alternatives**: Yahoo Finance (chosen), Alpha Vantage, IEX Cloud, Polygon.io
   - **Scope**: Cross-cutting - affects all data fetching, caching strategy, error handling
   - **Documentation**: See research.md "External Data Source Selection"
   - **ADR Recommendation**: Consider documenting as ADR if this becomes a long-term production system

2. **Caching Strategy (In-Memory vs Redis)**
   - **Impact**: Affects horizontal scaling capability, deployment complexity
   - **Alternatives**: In-memory cachetools (chosen for MVP), Redis (for production scale)
   - **Scope**: Cross-cutting - affects performance, deployment, operational overhead
   - **Documentation**: See research.md "Caching Strategy"
   - **ADR Recommendation**: Document when migrating to Redis for production

3. **Signal Generation Algorithm (Rule-Based vs ML)**
   - **Impact**: Long-term maintainability, accuracy, explainability
   - **Alternatives**: Rule-based scoring (chosen), Machine Learning, Single indicator, Third-party signals
   - **Scope**: Core business logic, affects all signal outputs
   - **Documentation**: See research.md "Signal Generation Algorithm"
   - **ADR Recommendation**: Document if migrating to ML-based approach

**ADR Creation**: To create an ADR for any of these decisions, run:
```bash
/sp.adr "Data Source Selection - Yahoo Finance for Stock Market Data"
```

---

## Implementation Phases

### Phase 0: Research ✅ COMPLETE
- [x] Evaluate data source options (Yahoo Finance vs Alpha Vantage)
- [x] Research technical indicator libraries (pandas-ta vs TA-Lib)
- [x] Select API framework (FastAPI)
- [x] Design caching strategy (cachetools)
- [x] Define signal generation algorithm
- [x] Document all decisions in research.md

### Phase 1: Design & Contracts ✅ COMPLETE
- [x] Define data models (Stock, PriceData, TechnicalIndicator, Signal)
- [x] Create OpenAPI specification (REST API contracts)
- [x] Document project structure
- [x] Write quickstart guide
- [x] Update plan.md with complete architecture

### Phase 2: Tasks Generation ⏳ NEXT
- [ ] Run `/sp.tasks` to generate actionable task list
- [ ] Break down implementation into testable increments
- [ ] Organize tasks by dependency order

### Phase 3: Implementation (TBD)
- [ ] Red phase: Write failing tests
- [ ] Green phase: Implement code to pass tests
- [ ] Refactor phase: Optimize and clean up
- [ ] Integration testing and validation

---

## Risk Analysis

| Risk | Likelihood | Impact | Mitigation | Owner |
|------|-----------|--------|------------|-------|
| Yahoo Finance API changes/deprecation | Medium | High | Monitor yfinance library updates; Document migration path to Alpha Vantage; Add health checks | Implementation Team |
| Rate limiting from data source | Low | Medium | 15-min cache with 80% hit rate target; Add per-IP throttling if needed | Implementation Team |
| Insufficient historical data (new IPOs) | Medium | Low | Graceful degradation with partial indicators; Clear messaging in signal reasoning | Implementation Team |
| Indicator calculation errors | Low | Medium | Comprehensive unit tests for each indicator; Validate against known benchmarks; Graceful fallback | Implementation Team |
| External API downtime | Low | High | Retry logic with exponential backoff; Clear error messages; Monitor uptime; FR-013 compliance | Implementation Team |
| Signal accuracy complaints | Medium | Medium | Document that signals are informational only (not financial advice); Add backtesting in post-MVP | Product Team |
| Cache memory exhaustion | Low | Low | LRU eviction with 500-ticker cap; Monitor memory usage; Upgrade to Redis if needed | Operations Team |

**Kill Switches / Guardrails**:
- Health check endpoint reports data source status (can be used by load balancers)
- Graceful degradation when data unavailable (503 with retry-after header)
- Cache size limits prevent memory exhaustion (LRU eviction)
- Ticker validation prevents injection attacks

---

## Non-Functional Requirements Validation

### Performance (SC-001, SC-007)
- **Target**: <2s for cached requests, 80% cache hit rate
- **Validation**: Load testing with Apache Bench (100 req, 10 concurrent)
- **Monitoring**: Response time metrics, cache hit rate metrics

### Reliability (SC-005)
- **Target**: 99% uptime despite external data source failures
- **Validation**: Integration tests with mocked data source failures
- **Monitoring**: Uptime checks, error rate metrics

### Correctness (SC-002)
- **Target**: 95% of valid ticker requests return all 4 indicator types
- **Validation**: Integration tests with diverse ticker samples
- **Monitoring**: Indicator calculation success rate

### Usability (SC-006)
- **Target**: 90% of signals reference at least 2 indicators in reasoning
- **Validation**: Unit tests for signal reasoning generation
- **Monitoring**: Reasoning quality checks in integration tests

---

## Dependencies & Integration Points

### External Dependencies
1. **Yahoo Finance** (via yfinance library)
   - **Purpose**: Historical price data (OHLCV)
   - **Rate Limits**: Reasonable for moderate usage (no hard caps documented)
   - **Fallback**: Alpha Vantage (requires API key, 5 req/min free tier)
   - **Health Check**: Probe in /health endpoint

### Internal Dependencies
- None (single-service MVP)

### Future Integration Points
- **Backtesting Service**: Would consume signals for historical performance analysis
- **Notification Service**: Would subscribe to signals for alerts
- **Portfolio Manager**: Would use signals for automated trading decisions

---

## Operational Readiness

### Observability
- **Logging**: Structured logging (JSON) for errors, data source calls, cache hits/misses
- **Metrics**: Response times, cache hit rate, indicator calculation success rate, error rates
- **Tracing**: Not required for MVP (consider for production)

### Deployment
- **Strategy**: Single-instance deployment for MVP
- **Rollback**: Standard container rollback (previous image)
- **Feature Flags**: Not required for MVP (all features always on)

### Runbooks
- **Data source outage**: Check /health endpoint, validate external API status, notify users via 503 responses
- **High error rate**: Check logs for indicator calculation failures, validate input data quality
- **Performance degradation**: Check cache hit rate, verify external API response times

---

## Testing Strategy

### Unit Tests (tests/unit/)
- **Coverage Target**: >80% for business logic
- **Focus**: Indicator calculations, signal generation logic, validators
- **Fast**: <1s total execution time

### Integration Tests (tests/integration/)
- **Coverage**: All API endpoints against OpenAPI contract
- **Focus**: End-to-end flows, external API integration, error handling
- **Duration**: <30s total execution time

### Contract Tests
- **Validation**: OpenAPI schema compliance for all responses
- **Tools**: FastAPI test client, pydantic validation

### Manual Testing Checklist
- See quickstart.md "Manual Test Checklist" section

---

## Definition of Done

This feature is complete when:

- [x] **Design Phase**
  - [x] All artifacts generated (research.md, data-model.md, contracts/openapi.yaml, quickstart.md, plan.md)
  - [x] Technical decisions documented with rationale
  - [x] Constitution check passed (or violations justified)
  - [x] OpenAPI contract defines all endpoints with examples
  - [x] Project structure documented

- [ ] **Implementation Phase** (TBD via /sp.tasks)
  - [ ] All functional requirements (FR-001 through FR-018) implemented
  - [ ] All user stories (P1, P2, P3) satisfied with passing acceptance scenarios
  - [ ] All success criteria (SC-001 through SC-008) validated
  - [ ] Unit test coverage >80% for business logic
  - [ ] Integration tests validate all API endpoints
  - [ ] Manual test checklist 100% passed
  - [ ] Performance benchmarks met (<2s cached, 80% hit rate)
  - [ ] Error handling validated for all edge cases
  - [ ] OpenAPI docs accessible at /docs endpoint
  - [ ] Health check endpoint operational

- [ ] **Documentation Phase** (TBD)
  - [ ] README.md updated with setup instructions
  - [ ] requirements.txt finalized
  - [ ] Quickstart guide validated with fresh environment
  - [ ] API examples tested and working

---

## Next Steps

1. **Generate Tasks** (IMMEDIATE NEXT ACTION):
   ```bash
   /sp.tasks
   ```
   This will create `tasks.md` with dependency-ordered, testable implementation tasks based on this plan.

2. **Review Tasks**: User reviews and approves task breakdown

3. **Begin Implementation**:
   ```bash
   /sp.implement
   ```
   Execute tasks in Red-Green-Refactor cycles with TDD

4. **Consider ADR Creation**: If any architectural decisions require formal documentation, run:
   ```bash
   /sp.adr "Decision Title"
   ```

---

**Planning Phase Complete** ✅

All design artifacts generated:
- ✅ research.md (technical decisions)
- ✅ data-model.md (entity definitions)
- ✅ contracts/openapi.yaml (API specification)
- ✅ quickstart.md (developer guide)
- ✅ plan.md (this file - complete architecture)

**Ready for**: `/sp.tasks` command to generate implementation task list.
