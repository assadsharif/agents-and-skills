# Data Model: User Authentication

**Feature**: User Authentication
**Branch**: `002-user-authentication`
**Date**: 2026-02-14

## Overview

This document defines the data structures for the User Authentication feature. All models are implemented using Pydantic v2 for validation and serialization. These models extend the existing Stock Signal API without modifying existing data structures.

---

## Domain Entities

### 1. User

Represents a registered API consumer.

**Source**: Created via registration endpoint, persisted to JSON file

**Attributes**:
```python
class User:
    id: str                  # UUID v4 string (e.g., "a1b2c3d4-...")
    name: str                # Display name (1-100 chars)
    email: str               # Unique email address
    api_key: str             # 32-char hex token (e.g., "a1b2c3d4e5f6...")
    status: UserStatus       # "active" | "disabled"
    created_at: datetime     # ISO 8601 UTC timestamp
    last_active_at: datetime # ISO 8601 UTC timestamp, updated on each request
    request_count: int       # Total lifetime request count
```

**Validation Rules**:
- `name`: Must be 1-100 characters, non-empty after trimming whitespace
- `email`: Must contain `@` and a domain part (basic format validation)
- `email`: Must be unique across all users (enforced at service layer)
- `api_key`: Exactly 32 hex characters, generated by system (not user-provided)
- `status`: Must be one of `"active"`, `"disabled"`
- `request_count`: Non-negative integer, starts at 0

**State Transitions**:
```
[Registration] → active
active → disabled  (admin disables)
disabled → active  (admin re-enables)
```

---

### 2. UserStatus (Enum)

Represents the account state.

```python
class UserStatus(str, Enum):
    ACTIVE = "active"
    DISABLED = "disabled"
```

---

### 3. RateLimitInfo

Represents the rate limit state for a single API key at a point in time. Not persisted — computed in-memory.

**Attributes**:
```python
class RateLimitInfo:
    limit: int               # Max requests per window (100)
    remaining: int           # Requests remaining in current window
    reset_at: datetime       # When the current window resets (UTC)
```

---

## Request/Response Models

### 4. UserRegistrationRequest

Input for creating a new user account.

```python
class UserRegistrationRequest:
    name: str    # 1-100 characters
    email: str   # Valid email format
```

### 5. UserRegistrationResponse

Returned after successful registration.

```python
class UserRegistrationResponse:
    id: str
    name: str
    email: str
    api_key: str         # Show ONCE at registration
    status: str
    created_at: datetime
    message: str         # "Registration successful. Store your API key securely."
```

### 6. UserDetailResponse

Returned for admin user detail queries (excludes API key for security).

```python
class UserDetailResponse:
    id: str
    name: str
    email: str
    status: str
    created_at: datetime
    last_active_at: datetime
    request_count: int
```

### 7. UserListResponse

Returned for admin list-all-users queries.

```python
class UserListResponse:
    users: list[UserDetailResponse]
    total: int
```

### 8. AdminKeyRegenerateResponse

Returned when admin regenerates a user's API key.

```python
class AdminKeyRegenerateResponse:
    id: str
    new_api_key: str
    message: str         # "API key regenerated. Old key is immediately invalid."
```

---

## Error Response Models

### 9. AuthenticationError (401)

```python
{
    "error": "authentication_required",
    "message": "Valid API key required. Include X-API-Key header."
}
```

### 10. ForbiddenError (403)

```python
{
    "error": "account_disabled",
    "message": "Account has been disabled. Contact administrator."
}
```

### 11. RateLimitError (429)

```python
{
    "error": "rate_limit_exceeded",
    "message": "Rate limit exceeded. 100 requests per hour.",
    "retry_after": 1800,
    "reset_at": "2026-02-14T13:00:00Z"
}
```

### 12. ConflictError (409)

```python
{
    "error": "email_already_registered",
    "message": "Email 'user@example.com' is already registered."
}
```

---

## Persistence Schema

### JSON File: `data/users.json`

```json
{
  "users": {
    "a1b2c3d4-e5f6-7890-abcd-ef1234567890": {
      "id": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
      "name": "John Doe",
      "email": "john@example.com",
      "api_key": "a1b2c3d4e5f67890a1b2c3d4e5f67890",
      "status": "active",
      "created_at": "2026-02-14T10:00:00Z",
      "last_active_at": "2026-02-14T12:30:00Z",
      "request_count": 42
    }
  }
}
```

**File Location**: `data/users.json` (relative to project root, created automatically if missing)

**Concurrency**: Protected by `threading.Lock` for all read/write operations. Writes use atomic temp-file-then-rename pattern.

---

## Relationships

```
User 1 ──── 1 API Key       (one active key per user)
User 1 ──── * Requests      (tracked in-memory for rate limiting)
Admin Key ──── * Admin Ops   (single master key, not a User entity)
```
