<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Stock Signal API Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        brand: { 50:'#f0fdf4', 100:'#dcfce7', 500:'#22c55e', 600:'#16a34a', 700:'#15803d', 900:'#14532d' },
        surface: { 50:'#f8fafc', 100:'#f1f5f9', 200:'#e2e8f0', 700:'#334155', 800:'#1e293b', 900:'#0f172a' }
      }
    }
  }
}
</script>
<style>
  body { font-family: 'Inter', system-ui, -apple-system, sans-serif; }
  .tab-active { border-bottom: 2px solid #22c55e; color: #22c55e; font-weight: 600; }
  .card { background: white; border-radius: 0.75rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1); padding: 1.5rem; }
  .badge-buy { background: #dcfce7; color: #15803d; }
  .badge-sell { background: #fee2e2; color: #991b1b; }
  .badge-hold { background: #fef3c7; color: #92400e; }
  .spinner { border: 3px solid #e2e8f0; border-top: 3px solid #22c55e; border-radius: 50%; width: 20px; height: 20px; animation: spin 0.8s linear infinite; display: inline-block; }
  @keyframes spin { to { transform: rotate(360deg); } }
  pre { white-space: pre-wrap; word-break: break-word; }
  .gauge { width: 120px; height: 60px; position: relative; overflow: hidden; }
  .gauge::before { content:''; display:block; width:120px; height:60px; border-radius: 60px 60px 0 0; background: conic-gradient(from 0.75turn, #ef4444 0%, #eab308 25%, #22c55e 50%); }
</style>
</head>
<body class="bg-surface-50 text-surface-800 min-h-screen">

<!-- Header -->
<header class="bg-surface-900 text-white">
  <div class="max-w-7xl mx-auto px-4 py-4 flex items-center justify-between">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 bg-brand-500 rounded-lg flex items-center justify-center font-bold text-lg">S</div>
      <div>
        <h1 class="text-lg font-bold leading-tight">Stock Signal API</h1>
        <p class="text-xs text-surface-200">Technical Analysis Dashboard</p>
      </div>
    </div>
    <div class="flex items-center gap-3">
      <span id="health-dot" class="w-2.5 h-2.5 rounded-full bg-gray-500"></span>
      <span id="health-text" class="text-xs text-surface-200">Checking...</span>
      <span class="text-xs text-surface-200 ml-4">v1.0.0</span>
    </div>
  </div>
</header>

<!-- Auth Bar -->
<div class="bg-surface-800 border-b border-surface-700">
  <div class="max-w-7xl mx-auto px-4 py-2.5 flex items-center gap-3 flex-wrap">
    <span class="text-xs text-surface-200 font-medium">API Key:</span>
    <input id="api-key" type="text" placeholder="Enter your API key or register below"
      class="flex-1 min-w-[200px] px-3 py-1.5 rounded-md bg-surface-900 border border-surface-700 text-white text-sm placeholder:text-surface-200 focus:outline-none focus:ring-1 focus:ring-brand-500">
    <button onclick="testAuth()" class="px-3 py-1.5 bg-brand-600 hover:bg-brand-700 text-white text-sm rounded-md transition">Test Key</button>
    <span id="auth-status" class="text-xs"></span>
  </div>
</div>

<!-- Navigation Tabs -->
<nav class="bg-white border-b">
  <div class="max-w-7xl mx-auto px-4 flex gap-1 overflow-x-auto">
    <button onclick="showTab('signals')" class="tab px-4 py-3 text-sm text-surface-700 hover:text-brand-600 transition tab-active" data-tab="signals">Signals</button>
    <button onclick="showTab('indicators')" class="tab px-4 py-3 text-sm text-surface-700 hover:text-brand-600 transition" data-tab="indicators">Indicators</button>
    <button onclick="showTab('auth')" class="tab px-4 py-3 text-sm text-surface-700 hover:text-brand-600 transition" data-tab="auth">Auth</button>
    <button onclick="showTab('portfolio')" class="tab px-4 py-3 text-sm text-surface-700 hover:text-brand-600 transition" data-tab="portfolio">Portfolio</button>
    <button onclick="showTab('alerts')" class="tab px-4 py-3 text-sm text-surface-700 hover:text-brand-600 transition" data-tab="alerts">Alerts</button>
    <button onclick="showTab('webhooks')" class="tab px-4 py-3 text-sm text-surface-700 hover:text-brand-600 transition" data-tab="webhooks">Webhooks</button>
  </div>
</nav>

<!-- Main Content -->
<main class="max-w-7xl mx-auto px-4 py-6">

  <!-- SIGNALS TAB -->
  <section id="tab-signals">
    <div class="card">
      <h2 class="text-lg font-semibold mb-4">Stock Signal Lookup</h2>
      <div class="flex gap-3 mb-6">
        <input id="signal-ticker" type="text" placeholder="e.g. AAPL" maxlength="5"
          class="px-3 py-2 border rounded-md w-32 uppercase focus:outline-none focus:ring-1 focus:ring-brand-500"
          onkeydown="if(event.key==='Enter') fetchSignal()">
        <button onclick="fetchSignal()" class="px-5 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-md transition">Get Signal</button>
      </div>
      <div id="signal-result" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="bg-surface-50 rounded-lg p-4 text-center">
            <p class="text-xs text-surface-700 mb-1 uppercase tracking-wide">Signal</p>
            <p id="sig-action" class="text-2xl font-bold"></p>
          </div>
          <div class="bg-surface-50 rounded-lg p-4 text-center">
            <p class="text-xs text-surface-700 mb-1 uppercase tracking-wide">Confidence</p>
            <p id="sig-confidence" class="text-2xl font-bold"></p>
          </div>
          <div class="bg-surface-50 rounded-lg p-4 text-center">
            <p class="text-xs text-surface-700 mb-1 uppercase tracking-wide">Price</p>
            <p id="sig-price" class="text-2xl font-bold"></p>
          </div>
        </div>
        <div class="bg-surface-50 rounded-lg p-4">
          <p class="text-xs text-surface-700 mb-1 uppercase tracking-wide">Reasoning</p>
          <p id="sig-reasoning" class="text-sm"></p>
        </div>
      </div>
      <div id="signal-loading" class="hidden text-center py-8"><div class="spinner"></div><p class="text-sm text-surface-700 mt-2">Analyzing...</p></div>
      <div id="signal-error" class="hidden text-red-600 text-sm mt-2"></div>
    </div>
  </section>

  <!-- INDICATORS TAB -->
  <section id="tab-indicators" class="hidden">
    <div class="card">
      <h2 class="text-lg font-semibold mb-4">Technical Indicators</h2>
      <div class="flex gap-3 mb-6">
        <input id="ind-ticker" type="text" placeholder="e.g. MSFT" maxlength="5"
          class="px-3 py-2 border rounded-md w-32 uppercase focus:outline-none focus:ring-1 focus:ring-brand-500"
          onkeydown="if(event.key==='Enter') fetchIndicators()">
        <button onclick="fetchIndicators()" class="px-5 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-md transition">Get Indicators</button>
      </div>
      <div id="ind-result" class="hidden">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
          <div class="bg-surface-50 rounded-lg p-4">
            <p class="text-xs text-surface-700 mb-2 uppercase tracking-wide font-medium">RSI (14)</p>
            <p id="ind-rsi" class="text-xl font-bold"></p>
            <p id="ind-rsi-label" class="text-xs mt-1"></p>
          </div>
          <div class="bg-surface-50 rounded-lg p-4">
            <p class="text-xs text-surface-700 mb-2 uppercase tracking-wide font-medium">MACD</p>
            <p id="ind-macd-line" class="text-sm"><span class="text-surface-700">Line:</span> <span class="font-mono font-semibold"></span></p>
            <p id="ind-macd-signal" class="text-sm"><span class="text-surface-700">Signal:</span> <span class="font-mono font-semibold"></span></p>
            <p id="ind-macd-hist" class="text-sm"><span class="text-surface-700">Histogram:</span> <span class="font-mono font-semibold"></span></p>
          </div>
          <div class="bg-surface-50 rounded-lg p-4">
            <p class="text-xs text-surface-700 mb-2 uppercase tracking-wide font-medium">SMA</p>
            <p id="ind-sma-20" class="text-sm"></p>
            <p id="ind-sma-50" class="text-sm"></p>
            <p id="ind-sma-200" class="text-sm"></p>
          </div>
          <div class="bg-surface-50 rounded-lg p-4">
            <p class="text-xs text-surface-700 mb-2 uppercase tracking-wide font-medium">EMA</p>
            <p id="ind-ema-12" class="text-sm"></p>
            <p id="ind-ema-26" class="text-sm"></p>
          </div>
        </div>
      </div>
      <div id="ind-loading" class="hidden text-center py-8"><div class="spinner"></div><p class="text-sm text-surface-700 mt-2">Calculating...</p></div>
      <div id="ind-error" class="hidden text-red-600 text-sm mt-2"></div>
    </div>
  </section>

  <!-- AUTH TAB -->
  <section id="tab-auth" class="hidden">
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">Register New Account</h2>
        <div class="space-y-3">
          <input id="reg-name" type="text" placeholder="Full name" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
          <input id="reg-email" type="email" placeholder="Email address" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
          <button onclick="register()" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-md transition">Register</button>
        </div>
        <div id="reg-result" class="hidden mt-4 p-3 bg-brand-50 border border-brand-100 rounded-md">
          <p class="text-sm font-medium text-brand-700">Registration successful!</p>
          <p class="text-xs mt-1 text-surface-700">Your API key: <code id="reg-api-key" class="font-mono bg-white px-1 py-0.5 rounded border text-brand-700 select-all"></code></p>
          <button onclick="useKey(document.getElementById('reg-api-key').textContent)" class="mt-2 text-xs px-3 py-1 bg-brand-600 text-white rounded hover:bg-brand-700">Use This Key</button>
        </div>
        <div id="reg-error" class="hidden mt-3 text-red-600 text-sm"></div>
      </div>
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">Account Info</h2>
        <p class="text-sm text-surface-700 mb-3">Enter your API key in the header bar, then click "Test Key" to view account details.</p>
        <div id="auth-info" class="hidden space-y-2">
          <div class="flex justify-between py-1 border-b"><span class="text-sm text-surface-700">Name</span><span id="ai-name" class="text-sm font-medium"></span></div>
          <div class="flex justify-between py-1 border-b"><span class="text-sm text-surface-700">Email</span><span id="ai-email" class="text-sm font-medium"></span></div>
          <div class="flex justify-between py-1 border-b"><span class="text-sm text-surface-700">Status</span><span id="ai-status" class="text-sm font-medium"></span></div>
          <div class="flex justify-between py-1 border-b"><span class="text-sm text-surface-700">Created</span><span id="ai-created" class="text-sm font-medium"></span></div>
          <div class="flex justify-between py-1"><span class="text-sm text-surface-700">Requests</span><span id="ai-requests" class="text-sm font-medium"></span></div>
        </div>
      </div>
    </div>
  </section>

  <!-- PORTFOLIO TAB -->
  <section id="tab-portfolio" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">Add Holding</h2>
        <div class="space-y-3">
          <input id="port-ticker" type="text" placeholder="Ticker (e.g. AAPL)" maxlength="5" class="w-full px-3 py-2 border rounded-md uppercase focus:outline-none focus:ring-1 focus:ring-brand-500">
          <input id="port-shares" type="number" placeholder="Shares" min="1" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
          <input id="port-cost" type="number" placeholder="Cost basis per share" step="0.01" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
          <button onclick="addHolding()" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-md transition">Add to Portfolio</button>
        </div>
        <div id="port-add-msg" class="hidden mt-3 text-sm"></div>
      </div>
      <div class="lg:col-span-2 card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">My Portfolio</h2>
          <button onclick="fetchPortfolio()" class="text-sm px-3 py-1 border rounded-md hover:bg-surface-50 transition">Refresh</button>
        </div>
        <div id="port-holdings" class="text-sm text-surface-700">Click Refresh to load portfolio.</div>
      </div>
    </div>
  </section>

  <!-- ALERTS TAB -->
  <section id="tab-alerts" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">Create Alert</h2>
        <div class="space-y-3">
          <select id="alert-type" onchange="updateAlertForm()" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
            <option value="price_threshold">Price Threshold</option>
            <option value="signal_change">Signal Change</option>
            <option value="portfolio_value">Portfolio Value</option>
          </select>
          <div id="alert-fields-price">
            <input id="alert-ticker" type="text" placeholder="Ticker" maxlength="5" class="w-full px-3 py-2 border rounded-md uppercase mb-3 focus:outline-none focus:ring-1 focus:ring-brand-500">
            <input id="alert-price" type="number" placeholder="Target price" step="0.01" class="w-full px-3 py-2 border rounded-md mb-3 focus:outline-none focus:ring-1 focus:ring-brand-500">
            <select id="alert-direction" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
              <option value="above">Above</option>
              <option value="below">Below</option>
            </select>
          </div>
          <div id="alert-fields-signal" class="hidden">
            <input id="alert-sig-ticker" type="text" placeholder="Ticker" maxlength="5" class="w-full px-3 py-2 border rounded-md uppercase mb-3 focus:outline-none focus:ring-1 focus:ring-brand-500">
            <select id="alert-target-signal" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
              <option value="buy">Buy</option>
              <option value="sell">Sell</option>
              <option value="hold">Hold</option>
            </select>
          </div>
          <div id="alert-fields-portfolio" class="hidden">
            <input id="alert-pct" type="number" placeholder="% threshold (e.g. 5.0)" step="0.1" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
          </div>
          <button onclick="createAlert()" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-md transition mt-2">Create Alert</button>
        </div>
        <div id="alert-msg" class="hidden mt-3 text-sm"></div>
      </div>
      <div class="lg:col-span-2 card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">My Alerts</h2>
          <div class="flex gap-2">
            <button onclick="checkTriggered()" class="text-sm px-3 py-1 bg-amber-100 text-amber-800 rounded-md hover:bg-amber-200 transition">Check Triggered</button>
            <button onclick="fetchAlerts()" class="text-sm px-3 py-1 border rounded-md hover:bg-surface-50 transition">Refresh</button>
          </div>
        </div>
        <div id="alerts-list" class="text-sm text-surface-700">Click Refresh to load alerts.</div>
        <div id="triggered-result" class="hidden mt-4 p-3 bg-amber-50 border border-amber-200 rounded-md text-sm"></div>
      </div>
    </div>
  </section>

  <!-- WEBHOOKS TAB -->
  <section id="tab-webhooks" class="hidden">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <div class="card">
        <h2 class="text-lg font-semibold mb-4">Webhook Configuration</h2>
        <div class="space-y-3">
          <input id="wh-url" type="url" placeholder="https://example.com/webhook" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
          <input id="wh-secret" type="text" placeholder="HMAC secret (optional)" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-1 focus:ring-brand-500">
          <button onclick="setWebhook()" class="w-full px-4 py-2 bg-brand-600 hover:bg-brand-700 text-white rounded-md transition">Save Webhook</button>
          <button onclick="deleteWebhook()" class="w-full px-4 py-2 border border-red-300 text-red-600 hover:bg-red-50 rounded-md transition">Delete Webhook</button>
        </div>
        <div id="wh-msg" class="hidden mt-3 text-sm"></div>
        <div id="wh-current" class="hidden mt-4 p-3 bg-surface-50 rounded-md">
          <p class="text-xs text-surface-700 uppercase tracking-wide mb-2 font-medium">Current Config</p>
          <div id="wh-info" class="text-sm space-y-1"></div>
        </div>
      </div>
      <div class="lg:col-span-2 card">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-lg font-semibold">Delivery History</h2>
          <button onclick="fetchWebhookHistory()" class="text-sm px-3 py-1 border rounded-md hover:bg-surface-50 transition">Refresh</button>
        </div>
        <div id="wh-history" class="text-sm text-surface-700">Click Refresh to load delivery history.</div>
      </div>
    </div>
  </section>

</main>

<!-- Footer -->
<footer class="border-t mt-8 py-4 text-center text-xs text-surface-700">
  Stock Signal API &mdash; Data from Yahoo Finance (15-min delay) &mdash;
  <a href="/docs" class="text-brand-600 hover:underline">Swagger UI</a> &middot;
  <a href="/redoc" class="text-brand-600 hover:underline">ReDoc</a>
</footer>

<script>
const API = location.hostname.includes('github.io')
  ? 'https://backend-api-project-1-d2vu.onrender.com'
  : '';
const h = (id) => document.getElementById(id);

function getKey() { return h('api-key').value.trim(); }
function headers() { return { 'X-API-Key': getKey(), 'Content-Type': 'application/json' }; }
function useKey(k) { h('api-key').value = k; testAuth(); }

// --- Tabs ---
function showTab(name) {
  document.querySelectorAll('[id^="tab-"]').forEach(el => el.classList.add('hidden'));
  document.querySelectorAll('.tab').forEach(el => el.classList.remove('tab-active'));
  h('tab-' + name).classList.remove('hidden');
  document.querySelector(`[data-tab="${name}"]`).classList.add('tab-active');
}

// --- Health ---
async function checkHealth() {
  try {
    const r = await fetch(API + '/health');
    const d = await r.json();
    h('health-dot').className = 'w-2.5 h-2.5 rounded-full ' + (d.status === 'healthy' ? 'bg-green-400' : 'bg-yellow-400');
    h('health-text').textContent = d.status === 'healthy' ? 'API Healthy' : 'Degraded';
  } catch {
    h('health-dot').className = 'w-2.5 h-2.5 rounded-full bg-red-400';
    h('health-text').textContent = 'Offline';
  }
}

// --- Auth ---
async function testAuth() {
  const key = getKey();
  if (!key) { h('auth-status').innerHTML = '<span class="text-yellow-400">Enter a key</span>'; return; }
  try {
    const r = await fetch(API + '/alerts', { headers: headers() });
    if (r.ok) {
      h('auth-status').innerHTML = '<span class="text-green-400">Authenticated</span>';
    } else {
      h('auth-status').innerHTML = '<span class="text-red-400">Invalid key (' + r.status + ')</span>';
    }
  } catch { h('auth-status').innerHTML = '<span class="text-red-400">Connection error</span>'; }
}

async function register() {
  const name = h('reg-name').value.trim();
  const email = h('reg-email').value.trim();
  if (!name || !email) { showMsg('reg-error', 'Name and email required', true); return; }
  try {
    const r = await fetch(API + '/auth/register', {
      method: 'POST', headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name, email })
    });
    const d = await r.json();
    if (r.ok) {
      h('reg-result').classList.remove('hidden');
      h('reg-error').classList.add('hidden');
      h('reg-api-key').textContent = d.api_key;
    } else {
      showMsg('reg-error', d.message || d.detail || JSON.stringify(d), true);
      h('reg-result').classList.add('hidden');
    }
  } catch(e) { showMsg('reg-error', 'Error: ' + e.message, true); }
}

// --- Signals ---
async function fetchSignal() {
  const ticker = h('signal-ticker').value.trim().toUpperCase();
  if (!ticker) return;
  h('signal-result').classList.add('hidden');
  h('signal-error').classList.add('hidden');
  h('signal-loading').classList.remove('hidden');
  try {
    const r = await fetch(API + '/signal/' + ticker, { headers: headers() });
    const d = await r.json();
    h('signal-loading').classList.add('hidden');
    if (!r.ok) { showMsg('signal-error', d.message || d.error || JSON.stringify(d), true); return; }
    h('signal-result').classList.remove('hidden');
    const action = d.signal || d.action || '';
    h('sig-action').textContent = action.toUpperCase();
    h('sig-action').className = 'text-2xl font-bold ' + (action === 'buy' ? 'text-green-600' : action === 'sell' ? 'text-red-600' : 'text-amber-600');
    h('sig-confidence').textContent = (d.confidence || 0) + '%';
    h('sig-price').textContent = '$' + (d.current_price || 0).toFixed(2);
    h('sig-reasoning').textContent = d.reasoning || '';
  } catch(e) { h('signal-loading').classList.add('hidden'); showMsg('signal-error', 'Error: ' + e.message, true); }
}

// --- Indicators ---
async function fetchIndicators() {
  const ticker = h('ind-ticker').value.trim().toUpperCase();
  if (!ticker) return;
  h('ind-result').classList.add('hidden');
  h('ind-error').classList.add('hidden');
  h('ind-loading').classList.remove('hidden');
  try {
    const r = await fetch(API + '/indicators/' + ticker, { headers: headers() });
    const d = await r.json();
    h('ind-loading').classList.add('hidden');
    if (!r.ok) { showMsg('ind-error', d.message || JSON.stringify(d), true); return; }
    h('ind-result').classList.remove('hidden');
    const ind = d.indicators || d;
    // RSI
    const rsi = ind.rsi;
    h('ind-rsi').textContent = rsi != null ? rsi.toFixed(2) : 'N/A';
    h('ind-rsi').className = 'text-xl font-bold ' + (rsi > 70 ? 'text-red-600' : rsi < 30 ? 'text-green-600' : '');
    h('ind-rsi-label').textContent = rsi > 70 ? 'Overbought' : rsi < 30 ? 'Oversold' : 'Neutral';
    h('ind-rsi-label').className = 'text-xs mt-1 ' + (rsi > 70 ? 'text-red-500' : rsi < 30 ? 'text-green-500' : 'text-surface-700');
    // MACD
    const macd = ind.macd || {};
    h('ind-macd-line').innerHTML = `<span class="text-surface-700">Line:</span> <span class="font-mono font-semibold">${fmt(macd.line)}</span>`;
    h('ind-macd-signal').innerHTML = `<span class="text-surface-700">Signal:</span> <span class="font-mono font-semibold">${fmt(macd.signal)}</span>`;
    h('ind-macd-hist').innerHTML = `<span class="text-surface-700">Hist:</span> <span class="font-mono font-semibold ${macd.histogram > 0 ? 'text-green-600' : macd.histogram < 0 ? 'text-red-600' : ''}">${fmt(macd.histogram)}</span>`;
    // SMA
    const sma = ind.sma || {};
    h('ind-sma-20').innerHTML = `<span class="text-surface-700">20-day:</span> <span class="font-mono font-semibold">${fmt(sma['20_day'])}</span>`;
    h('ind-sma-50').innerHTML = `<span class="text-surface-700">50-day:</span> <span class="font-mono font-semibold">${fmt(sma['50_day'])}</span>`;
    h('ind-sma-200').innerHTML = `<span class="text-surface-700">200-day:</span> <span class="font-mono font-semibold">${fmt(sma['200_day'])}</span>`;
    // EMA
    const ema = ind.ema || {};
    h('ind-ema-12').innerHTML = `<span class="text-surface-700">12-day:</span> <span class="font-mono font-semibold">${fmt(ema['12_day'])}</span>`;
    h('ind-ema-26').innerHTML = `<span class="text-surface-700">26-day:</span> <span class="font-mono font-semibold">${fmt(ema['26_day'])}</span>`;
  } catch(e) { h('ind-loading').classList.add('hidden'); showMsg('ind-error', 'Error: ' + e.message, true); }
}

function fmt(v) { return v != null ? Number(v).toFixed(2) : '<span class="text-surface-200">N/A</span>'; }

// --- Portfolio ---
async function addHolding() {
  const ticker = h('port-ticker').value.trim().toUpperCase();
  const shares = parseInt(h('port-shares').value);
  const cost = parseFloat(h('port-cost').value);
  if (!ticker || !shares) { showMsg('port-add-msg', 'Ticker and shares required', true); return; }
  try {
    const body = { ticker, shares };
    if (cost) body.cost_basis = cost;
    const r = await fetch(API + '/portfolio/holdings', { method: 'POST', headers: headers(), body: JSON.stringify(body) });
    const d = await r.json();
    if (r.ok || r.status === 201) {
      showMsg('port-add-msg', 'Added ' + ticker, false);
      fetchPortfolio();
    } else { showMsg('port-add-msg', d.message || d.error || JSON.stringify(d), true); }
  } catch(e) { showMsg('port-add-msg', 'Error: ' + e.message, true); }
}

async function fetchPortfolio() {
  try {
    const r = await fetch(API + '/portfolio', { headers: headers() });
    const d = await r.json();
    if (!r.ok) { h('port-holdings').innerHTML = '<p class="text-red-500">' + (d.message || r.status) + '</p>'; return; }
    const holdings = d.holdings || [];
    if (!holdings.length) { h('port-holdings').innerHTML = '<p class="text-surface-700">No holdings yet. Add some above.</p>'; return; }
    let html = '<table class="w-full text-sm"><thead><tr class="border-b text-left text-xs text-surface-700 uppercase"><th class="py-2">Ticker</th><th>Shares</th><th>Cost Basis</th><th>Added</th><th></th></tr></thead><tbody>';
    holdings.forEach(hold => {
      html += `<tr class="border-b"><td class="py-2 font-mono font-semibold">${hold.ticker}</td><td>${hold.shares}</td><td>${hold.cost_basis ? '$' + hold.cost_basis.toFixed(2) : '-'}</td><td class="text-xs text-surface-700">${new Date(hold.added_at).toLocaleDateString()}</td><td><button onclick="removeHolding('${hold.ticker}')" class="text-red-500 hover:text-red-700 text-xs">Remove</button></td></tr>`;
    });
    html += '</tbody></table>';
    h('port-holdings').innerHTML = html;
  } catch(e) { h('port-holdings').innerHTML = '<p class="text-red-500">Error: ' + e.message + '</p>'; }
}

async function removeHolding(ticker) {
  await fetch(API + '/portfolio/holdings/' + ticker, { method: 'DELETE', headers: headers() });
  fetchPortfolio();
}

// --- Alerts ---
function updateAlertForm() {
  const type = h('alert-type').value;
  h('alert-fields-price').classList.toggle('hidden', type !== 'price_threshold');
  h('alert-fields-signal').classList.toggle('hidden', type !== 'signal_change');
  h('alert-fields-portfolio').classList.toggle('hidden', type !== 'portfolio_value');
}

async function createAlert() {
  const type = h('alert-type').value;
  let body = { alert_type: type };
  if (type === 'price_threshold') {
    body.ticker = h('alert-ticker').value.trim().toUpperCase();
    body.target_price = parseFloat(h('alert-price').value);
    body.price_direction = h('alert-direction').value;
  } else if (type === 'signal_change') {
    body.ticker = h('alert-sig-ticker').value.trim().toUpperCase();
    body.target_signal = h('alert-target-signal').value;
  } else {
    body.percentage_threshold = parseFloat(h('alert-pct').value);
  }
  try {
    const r = await fetch(API + '/alerts', { method: 'POST', headers: headers(), body: JSON.stringify(body) });
    const d = await r.json();
    if (r.ok || r.status === 201) { showMsg('alert-msg', 'Alert created: ' + d.id, false); fetchAlerts(); }
    else { showMsg('alert-msg', d.message || d.error || JSON.stringify(d), true); }
  } catch(e) { showMsg('alert-msg', 'Error: ' + e.message, true); }
}

async function fetchAlerts() {
  try {
    const r = await fetch(API + '/alerts', { headers: headers() });
    const d = await r.json();
    if (!r.ok) { h('alerts-list').innerHTML = '<p class="text-red-500">' + (d.message || r.status) + '</p>'; return; }
    const alerts = d.alerts || [];
    if (!alerts.length) { h('alerts-list').innerHTML = '<p class="text-surface-700">No alerts configured.</p>'; return; }
    let html = '<div class="space-y-2">';
    alerts.forEach(a => {
      let desc = a.alert_type;
      if (a.ticker) desc += ' | ' + a.ticker;
      if (a.target_price) desc += ' ' + (a.price_direction || '') + ' $' + a.target_price;
      if (a.target_signal) desc += ' -> ' + a.target_signal;
      if (a.percentage_threshold) desc += ' ' + a.percentage_threshold + '%';
      html += `<div class="flex items-center justify-between p-2 bg-surface-50 rounded-md">
        <div><span class="text-xs font-mono text-surface-700">${a.id.slice(0,8)}</span> <span class="font-medium ml-2">${desc}</span></div>
        <button onclick="deleteAlert('${a.id}')" class="text-red-500 hover:text-red-700 text-xs px-2 py-1">Delete</button>
      </div>`;
    });
    html += '</div>';
    h('alerts-list').innerHTML = html;
  } catch(e) { h('alerts-list').innerHTML = '<p class="text-red-500">Error: ' + e.message + '</p>'; }
}

async function deleteAlert(id) {
  await fetch(API + '/alerts/' + id, { method: 'DELETE', headers: headers() });
  fetchAlerts();
}

async function checkTriggered() {
  h('triggered-result').classList.remove('hidden');
  h('triggered-result').innerHTML = '<div class="spinner"></div> Evaluating alerts...';
  try {
    const r = await fetch(API + '/alerts/triggered', { headers: headers() });
    const d = await r.json();
    if (!r.ok) { h('triggered-result').innerHTML = '<span class="text-red-600">' + (d.message || r.status) + '</span>'; return; }
    const s = d.summary || {};
    let html = `<p><strong>${s.triggered_count || 0}</strong> triggered out of <strong>${s.total_alerts || 0}</strong> alerts</p>`;
    if (d.results && d.results.length) {
      d.results.forEach(res => {
        const icon = res.triggered ? '&#x1f534;' : '&#x26aa;';
        html += `<div class="mt-1">${icon} ${res.alert?.ticker || ''} ${res.alert?.alert_type || ''} - ${res.triggered ? 'TRIGGERED' : 'not triggered'}</div>`;
      });
    }
    h('triggered-result').innerHTML = html;
  } catch(e) { h('triggered-result').innerHTML = '<span class="text-red-600">Error: ' + e.message + '</span>'; }
}

// --- Webhooks ---
async function setWebhook() {
  const url = h('wh-url').value.trim();
  if (!url) { showMsg('wh-msg', 'URL is required', true); return; }
  const body = { url };
  const secret = h('wh-secret').value.trim();
  if (secret) body.secret = secret;
  try {
    const r = await fetch(API + '/webhooks', { method: 'POST', headers: headers(), body: JSON.stringify(body) });
    const d = await r.json();
    if (r.ok || r.status === 201) { showMsg('wh-msg', d.message || 'Webhook saved', false); fetchWebhookConfig(); }
    else { showMsg('wh-msg', d.message || d.error || JSON.stringify(d), true); }
  } catch(e) { showMsg('wh-msg', 'Error: ' + e.message, true); }
}

async function deleteWebhook() {
  try {
    const r = await fetch(API + '/webhooks', { method: 'DELETE', headers: headers() });
    const d = await r.json();
    if (r.ok) { showMsg('wh-msg', 'Webhook deleted', false); h('wh-current').classList.add('hidden'); }
    else { showMsg('wh-msg', d.message || d.error || JSON.stringify(d), true); }
  } catch(e) { showMsg('wh-msg', 'Error: ' + e.message, true); }
}

async function fetchWebhookConfig() {
  try {
    const r = await fetch(API + '/webhooks', { headers: headers() });
    const d = await r.json();
    if (r.ok && d.url) {
      h('wh-current').classList.remove('hidden');
      h('wh-info').innerHTML = `
        <div class="flex justify-between"><span class="text-surface-700">URL</span><span class="font-mono text-xs">${d.url}</span></div>
        <div class="flex justify-between"><span class="text-surface-700">Secret</span><span>${d.has_secret ? 'Configured' : 'None'}</span></div>
        <div class="flex justify-between"><span class="text-surface-700">Active</span><span>${d.is_active ? '<span class="text-green-600">Yes</span>' : '<span class="text-red-600">No</span>'}</span></div>`;
    } else { h('wh-current').classList.add('hidden'); }
  } catch {}
}

async function fetchWebhookHistory() {
  try {
    const r = await fetch(API + '/webhooks/history', { headers: headers() });
    const d = await r.json();
    if (!r.ok) { h('wh-history').innerHTML = '<p class="text-red-500">' + (d.message || r.status) + '</p>'; return; }
    const dels = d.deliveries || [];
    if (!dels.length) { h('wh-history').innerHTML = '<p class="text-surface-700">No deliveries yet.</p>'; return; }
    let html = '<div class="space-y-2">';
    dels.forEach(del => {
      const color = del.status === 'delivered' ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200';
      const badge = del.status === 'delivered' ? '<span class="text-xs px-1.5 py-0.5 bg-green-100 text-green-700 rounded">Delivered</span>' : '<span class="text-xs px-1.5 py-0.5 bg-red-100 text-red-700 rounded">Failed</span>';
      html += `<div class="p-2 ${color} border rounded-md">
        <div class="flex items-center justify-between">
          <div>${badge} <span class="text-xs font-mono ml-2">${del.id?.slice(0,8) || ''}</span></div>
          <span class="text-xs text-surface-700">${del.attempts} attempt${del.attempts > 1 ? 's' : ''} | HTTP ${del.http_status || 'N/A'}</span>
        </div>
        <p class="text-xs mt-1 text-surface-700">${del.payload_summary || ''}</p>
        ${del.failure_reason ? '<p class="text-xs mt-1 text-red-600">' + del.failure_reason + '</p>' : ''}
      </div>`;
    });
    html += '</div>';
    h('wh-history').innerHTML = html;
  } catch(e) { h('wh-history').innerHTML = '<p class="text-red-500">Error: ' + e.message + '</p>'; }
}

// --- Helpers ---
function showMsg(id, msg, isError) {
  const el = h(id);
  el.classList.remove('hidden');
  el.className = el.className.replace(/text-\w+-\d+/g, '');
  el.classList.add(isError ? 'text-red-600' : 'text-green-600');
  el.textContent = msg;
  if (!isError) setTimeout(() => el.classList.add('hidden'), 4000);
}

// Init
checkHealth();
</script>
</body>
</html>
